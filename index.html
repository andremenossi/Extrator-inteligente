<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>AutoMed Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: transparent; overflow: hidden; }
        .drag-region { -webkit-app-region: drag; }
        .no-drag { -webkit-app-region: no-drag; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #475569; transition: all 0.3s; }
        .status-dot.active { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        
        .url-input {
            background: #0f172a;
            border: 1px solid #334155;
            color: #94a3b8;
        }
        .url-input:focus {
            border-color: #3b82f6;
            color: white;
            outline: none;
        }
        
        .selecting-mode { border-color: #f59e0b !important; color: #f59e0b !important; }
        .selecting-mode .status-dot { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; animate: pulse 1s infinite; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="h-screen w-screen flex flex-col p-2">
    
    <div class="flex-1 bg-slate-900/95 backdrop-blur-md border border-slate-700 rounded-xl shadow-2xl flex flex-col overflow-hidden text-slate-200">
        
        <div class="h-10 bg-slate-950/50 flex items-center justify-between px-4 drag-region select-none border-b border-slate-800">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-blue-500 rounded-sm"></div>
                <span class="text-xs font-bold tracking-wider text-white">AUTOMED G.O</span>
            </div>
            <button id="btnClose" class="no-drag text-slate-400 hover:text-red-400 transition-colors">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>

        <div class="flex-1 p-5 flex flex-col gap-4 overflow-y-auto">
            
            <div class="flex flex-col gap-1">
                <label class="text-[10px] text-slate-500 uppercase font-bold pl-1">Endereço do Sistema</label>
                <div class="flex gap-2">
                    <input id="inputUrl" type="text" class="url-input w-full text-xs rounded px-2 py-2" value="https://intranet.hepresidenteprudente.org.br/">
                    <button id="btnOpenBrowser" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded transition-colors" title="Ir para o site">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
            </div>

            <div class="bg-slate-950 rounded-lg p-4 border border-slate-800 relative overflow-hidden group">
                <div class="relative z-10 flex justify-between items-end">
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Status Atual</p>
                        <p id="statusText" class="text-sm font-mono text-blue-400 font-bold truncate">Aguardando...</p>
                    </div>
                    <span id="progressText" class="text-2xl font-bold text-white">0%</span>
                </div>
                <div id="progressBar" class="absolute bottom-0 left-0 h-1 bg-blue-600 transition-all duration-300 w-0"></div>
            </div>

            <div class="space-y-2 mt-2">
                <p class="text-[10px] text-slate-500 uppercase font-bold pl-1">Ensinar Robô</p>
                
                <div class="relative">
                    <button id="btnTable" onclick="triggerSelect('TABLE')" class="w-full flex items-center justify-between p-3 rounded bg-slate-800/50 hover:bg-slate-800 border border-transparent hover:border-slate-600 transition-all group">
                        <span class="text-xs font-medium">1. Selecionar Tabela</span>
                        <div id="dotTable" class="status-dot"></div>
                    </button>
                    <button onclick="cancelSelect('TABLE')" id="cancelTable" class="hidden absolute right-8 top-3 text-red-500 hover:text-red-400" title="Cancelar Seleção">
                         <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>

                <div class="relative">
                    <button id="btnButton" onclick="triggerSelect('BUTTON')" class="w-full flex items-center justify-between p-3 rounded bg-slate-800/50 hover:bg-slate-800 border border-transparent hover:border-slate-600 transition-all group">
                        <span class="text-xs font-medium">2. Botão de Ação</span>
                        <div id="dotButton" class="status-dot"></div>
                    </button>
                    <button onclick="cancelSelect('BUTTON')" id="cancelButton" class="hidden absolute right-8 top-3 text-red-500 hover:text-red-400" title="Cancelar Seleção">
                         <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>

                <div class="relative">
                    <button id="btnDetails" onclick="triggerSelect('DETAILS')" class="w-full flex items-center justify-between p-3 rounded bg-slate-800/50 hover:bg-slate-800 border border-transparent hover:border-slate-600 transition-all group">
                        <span class="text-xs font-medium">3. Área de Detalhes</span>
                        <div id="dotDetails" class="status-dot"></div>
                    </button>
                    <button onclick="cancelSelect('DETAILS')" id="cancelDetails" class="hidden absolute right-8 top-3 text-red-500 hover:text-red-400" title="Cancelar Seleção">
                         <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <div class="mt-auto pt-4 border-t border-slate-800">
                <div class="flex items-center justify-between mb-3 px-1">
                    <span class="text-xs text-slate-400">Limite de Pacientes:</span>
                    <input id="inputMaxRows" type="number" value="50" class="w-16 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs text-center text-white focus:border-blue-500 outline-none">
                </div>

                <div id="controlsContainer">
                    <button id="btnStart" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 transition-all active:scale-95">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        INICIAR EXTRAÇÃO
                    </button>
                    
                    <button id="btnStop" class="hidden w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-red-900/20 flex items-center justify-center gap-2 transition-all active:scale-95 animate-pulse">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
                        PARAR AGORA
                    </button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="root" style="display: none;"></div>

    <script>
        const { ipcRenderer } = require('electron');

        const btnClose = document.getElementById('btnClose');
        const btnOpenBrowser = document.getElementById('btnOpenBrowser');
        const inputUrl = document.getElementById('inputUrl');
        
        const statusText = document.getElementById('statusText');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const inputMaxRows = document.getElementById('inputMaxRows');

        const dotTable = document.getElementById('dotTable');
        const dotButton = document.getElementById('dotButton');
        const dotDetails = document.getElementById('dotDetails');

        const savedUrl = localStorage.getItem('lastUrl');
        if(savedUrl) inputUrl.value = savedUrl;

        btnClose.onclick = () => ipcRenderer.send('app-close');
        
        btnOpenBrowser.onclick = () => {
            const url = inputUrl.value;
            localStorage.setItem('lastUrl', url);
            ipcRenderer.send('open-browser', url);
        };
        
        // State to track if selecting
        let currentSelectionMode = null;

        window.triggerSelect = (mode) => {
            if (currentSelectionMode) return; // Already selecting
            currentSelectionMode = mode;
            
            // Visual Updates
            updateSelectionUI(mode, true);
            
            ipcRenderer.send('trigger-select', mode);
            statusText.innerText = 'Selecione no navegador...';
            statusText.className = 'text-sm font-mono text-amber-500 font-bold truncate';
        };

        window.cancelSelect = (mode) => {
            currentSelectionMode = null;
            updateSelectionUI(mode, false);
            ipcRenderer.send('cancel-select');
            statusText.innerText = 'Seleção cancelada.';
            statusText.className = 'text-sm font-mono text-slate-400 font-bold truncate';
        };

        function updateSelectionUI(mode, isSelecting) {
            const btnId = mode === 'TABLE' ? 'btnTable' : mode === 'BUTTON' ? 'btnButton' : 'btnDetails';
            const cancelId = mode === 'TABLE' ? 'cancelTable' : mode === 'BUTTON' ? 'cancelButton' : 'cancelDetails';
            
            const btn = document.getElementById(btnId);
            const cancel = document.getElementById(cancelId);
            
            if (isSelecting) {
                btn.classList.add('selecting-mode');
                cancel.classList.remove('hidden');
            } else {
                btn.classList.remove('selecting-mode');
                cancel.classList.add('hidden');
            }
        }

        btnStart.onclick = () => {
            if(!dotButton.classList.contains('active')) {
                statusText.innerText = "Configure o Botão (Passo 2)!";
                statusText.classList.add('text-red-400');
                setTimeout(() => statusText.classList.remove('text-red-400'), 2000);
                return;
            }
            toggleRunning(true);
            ipcRenderer.send('start-extraction', { maxRows: Number(inputMaxRows.value) });
        };

        btnStop.onclick = () => {
            toggleRunning(false);
            statusText.innerText = "Parando...";
            ipcRenderer.send('stop-extraction');
        };

        function toggleRunning(isRunning) {
            if(isRunning) {
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');
            } else {
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
            }
        }

        ipcRenderer.on('status', (e, msg) => {
            statusText.innerText = msg;
            statusText.className = 'text-sm font-mono text-blue-400 font-bold truncate';
            if(msg.includes('Salvo') || msg.includes('Parado')) toggleRunning(false);
        });

        ipcRenderer.on('progress', (e, p) => {
            const pct = Math.round((p.current / p.total) * 100);
            progressText.innerText = pct + '%';
            progressBar.style.width = pct + '%';
        });

        ipcRenderer.on('config-update', (e, data) => {
            // Stop selection visuals
            if(currentSelectionMode) {
                updateSelectionUI(currentSelectionMode, false);
                currentSelectionMode = null;
            }

            if(data.mode === 'TABLE') dotTable.classList.add('active');
            if(data.mode === 'BUTTON') dotButton.classList.add('active');
            if(data.mode === 'DETAILS') dotDetails.classList.add('active');
            statusText.innerText = `${data.desc || 'Configurado'}!`;
            statusText.className = 'text-sm font-mono text-green-400 font-bold truncate';
        });
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>